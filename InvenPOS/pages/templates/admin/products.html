{% extends 'navigation/navbar.html' %}
{% load static %}

{% block title %}Products{% endblock %}
{% block content %}
<div class="products-container">
  <!-- Header -->
  <div class="page-header d-flex align-items-center justify-content-between">
    <div>
      <h1 class="page-title">Products Management</h1>
    </div>

    <div class="d-flex gap-2">
      <!-- ðŸ§¾ Manage Category Button -->
      <button class="btn-manage-category" data-bs-toggle="modal" data-bs-target="#manageCategoryModal">
        <i class="bi bi-tags"></i>
        <span>Manage Category</span>
      </button>

      <!-- âž• Add Product Button -->
      <button class="btn-add-product" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-lg"></i>
        <span>Add Product</span>
      </button>
    </div>
  </div>

  <!-- Search & Filters Bar -->
  <div class="controls-bar">
    <div class="search-wrapper">
      <form method="GET" action="{% url 'pages:products' %}">
        <i class="bi bi-search"></i>
        <input type="text" name="q" placeholder="Search products..." value="{{ request.GET.q }}">
      </form>
    </div>

    <div class="filter-group">
      <form method="GET" action="{% url 'pages:products' %}" id="categoryForm">
        <select name="category" class="filter-select" onchange="this.form.submit()">
          <option value="">All Categories</option>
          {% for cat in categories %}
          <option value="{{ cat.id }}" {% if selected_category and selected_category.id == cat.id %}selected{% endif %}>
            {{ cat.name }}
          </option>
          {% endfor %}
        </select>
      </form>
      <button class="btn-filter-add" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Add Category">
        <i class="bi bi-plus-lg"></i>
      </button>
    </div>
  </div>

  <!-- Products Grid -->
  <div class="products-grid">
    {% for product in products %}
    <div class="product-card position-relative">

      <!-- âœï¸ Edit Icon -->
      <button class="btn position-absolute top-0 end-0 edit-btn"
  data-bs-toggle="modal" data-bs-target="#editProductModal{{ product.id }}">
  <i class="bi bi-pencil"></i>
</button>

      <!-- ðŸ–¼ Product Image -->
      <div class="product-image-wrapper">
        {% if product.product_img %}
        <img src="{{ product.product_img.url }}" alt="{{ product.product_name }}" class="product-img">
        {% else %}
        <div class="product-img-placeholder"><i class="bi bi-image"></i></div>
        {% endif %}
        <div class="product-badges">
          {% if product.product_quantity <= 5 %}
          <span class="badge badge-warning">Low Stock</span>
          {% endif %}
        </div>
      </div>

      <div class="product-info">
        <div class="product-category">{{ product.product_category }}</div>
        <h3 class="product-name">{{ product.product_name }}</h3>
        <div class="product-details">
          <div class="product-price">â‚±{{ product.product_price }}</div>
          <div class="product-quantity {% if product.product_quantity <= 5 %}quantity-low{% endif %}">
            {{ product.product_quantity }} in stock
          </div>
        </div>

        <div class="product-actions">
          <button class="btn-action btn-primary" data-bs-toggle="modal" data-bs-target="#restockModal{{ product.id }}">
            Restock
          </button>
          <a href="{% url 'pages:delete_product' product.id %}" class="btn-action btn-delete"
            onclick="return confirm('Delete {{ product.product_name }}?');">
            Delete
          </a>
        </div>
      </div>
    </div>

    <!-- ðŸ§¾ RESTOCK MODAL -->
    <div class="modal fade" id="restockModal{{ product.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header text-black">
            <h5 class="modal-title">Restock Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <form action="{% url 'pages:restock_product' product.id %}" method="POST">
            {% csrf_token %}
            <div class="modal-body">
              <p class="fw-semibold mb-2">Product: {{ product.product_name }}</p>
              <div class="mb-3">
                <label class="form-label">Restock Quantity</label>
                <input type="number" name="restock_qty" class="form-control" placeholder="Enter quantity" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Supplier</label>
                <select name="supplier" class="form-select" required>
                  <option value="">-- Select Supplier --</option>
                  {% for supplier in suppliers %}
                  <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                  {% empty %}
                  <option disabled>No suppliers available</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Confirm Restock</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% include 'modals/edit_product_modal.html' with product=product %}
    {% empty %}
    <div class="empty-state">
      <i class="bi bi-inbox"></i>
      <h3>No products found</h3>
      <p>{% if request.GET.category or request.GET.q %}Try adjusting your search or filters{% else %}Get started by adding your first product{% endif %}</p>
    </div>
    {% endfor %}
  </div>

  {% if products.has_other_pages %}
  <div class="pagination-wrapper">
    <div class="pagination-info">Page {{ products.number }} of {{ paginator.num_pages }}</div>
    <nav class="pagination">
      {% if products.has_previous %}
      <a href="?page={{ products.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}"
        class="page-btn"><i class="bi bi-chevron-left"></i></a>
      {% else %}
      <span class="page-btn disabled"><i class="bi bi-chevron-left"></i></span>
      {% endif %}

      {% for i in page_range %}
      <a href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}"
        class="page-btn {% if products.number == i %}active{% endif %}">{{ i }}</a>
      {% endfor %}

      {% if products.has_next %}
      <a href="?page={{ products.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}"
        class="page-btn"><i class="bi bi-chevron-right"></i></a>
      {% else %}
      <span class="page-btn disabled"><i class="bi bi-chevron-right"></i></span>
      {% endif %}
    </nav>
  </div>
  {% endif %}
</div>

<!-- ADD PRODUCT MODAL -->
{% include 'modals/add_product_modal.html' %}

<!-- ADD CATEGORY MODAL -->
{% include 'modals/add_category_modal.html' %}

<!-- MANAGE CATEGORY MODAL -->
{% include 'modals/manage_category_modal.html' %}


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}
